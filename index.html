<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NYSE HALT MONITOR</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; font-size: 14px; font-weight: 700; background:#000; color:#fff; margin:0; }
  table { width:100%; border-collapse:collapse; table-layout:auto; letter-spacing:-0.5px; }
  th, td { border:1px solid #333; padding:2px 6px; white-space:nowrap; overflow:hidden; }
  th { background:#1a1a1a; color:#00ff00; text-align:left; font-size:11px; text-transform:uppercase; }
  .no-resume { background-color:#FFD700 !important; color:#000 !important; }
  #status { padding:6px; font-size:10px; color:#aaa; background:#080808; }
</style>
</head>
<body>
<div id="status">CONNECTING...</div>
<table>
  <thead>
    <tr>
      <th>Sym</th>
      <th>Halted</th>
      <th>Resume</th>
      <th>Reason</th>
      <th>Exch</th>
    </tr>
  </thead>
  <tbody id="haltBody"></tbody>
</table>

<script>
  // Toggle this:
  const ONLY_LULD = true;     // set false to show ALL halts
  const ONLY_TODAY = false;   // set true if you want to filter by today's date (ET-ish; NYSE strings are dates)

  function isLuldReason(reason) {
    const r = (reason || "").toLowerCase();
    return r.includes("luld") || r.includes("limit up") || r.includes("limit down");
  }

  async function fetchHaltData() {
    const tbody = document.getElementById('haltBody');
    const status = document.getElementById('status');

    const ts = Date.now();
    const target = `https://www.nyse.com/api/trade-halts/current?_=${ts}`;
    const proxyUrl = `https://corsproxy.io/?url=${encodeURIComponent(target)}`;

    try {
      const resp = await fetch(proxyUrl, { cache: "no-store" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

      const data = await resp.json();

      // NYSE current endpoint returns { totalCount, results: { lastUpdatedTime, tradeHalts: [...] } }
      const halts = data?.results?.tradeHalts ?? [];
      const lastUpdated = data?.results?.formatedLastUpdatedTime || data?.results?.lastUpdatedTime || "";

      // Optional: filter today's rows (NYSE date strings look like YYYY-MM-DD)
      const today = new Date().toISOString().slice(0, 10);
      let rows = halts;

      if (ONLY_TODAY) rows = rows.filter(h => (h.formatedHaltDate || "") === today);
      if (ONLY_LULD) rows = rows.filter(h => isLuldReason(h.reason));

      tbody.innerHTML = "";

      if (rows.length === 0) {
        status.innerText = `OK ${new Date().toLocaleTimeString()} | lastUpdated=${lastUpdated} | rows=0 (try ONLY_LULD=false)`;
        return;
      }

      for (const item of rows) {
        const tr = document.createElement('tr');
        const resumeT = (item.formatedResumptionTime || "").trim();
        if (!resumeT) tr.className = 'no-resume';

        tr.innerHTML = `
          <td>${item.symbol || '---'}</td>
          <td>${item.formatedHaltTime || '--:--'}</td>
          <td>${resumeT || 'PENDING'}</td>
          <td>${item.reason || ''}</td>
          <td>${item.sourceExchange || ''}</td>
        `;
        tbody.appendChild(tr);
      }

      status.innerText = `OK ${new Date().toLocaleTimeString()} | lastUpdated=${lastUpdated} | shown=${rows.length} | total=${halts.length}`;
    } catch (e) {
      status.innerText = `OFFLINE/ERROR ${new Date().toLocaleTimeString()} | ${e.message}`;
      tbody.innerHTML = "";
    }
  }

  fetchHaltData();
  setInterval(fetchHaltData, 15000); // poll instead of reloading the whole page
</script>
</body>
</html>
