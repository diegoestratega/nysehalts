<script>
async function fetchHaltData() {
    const tbody = document.getElementById('haltBody');
    const status = document.getElementById('status');
    
    // 1. Setup URL
    const timestamp = Date.now();
    const targetUrl = `https://www.nyse.com/api/trade-halts/current?_=${timestamp}`;
    const proxyUrl = `https://corsproxy.io/?url=${encodeURIComponent(targetUrl)}`;

    status.innerHTML = "Requesting data...";

    try {
        const response = await fetch(proxyUrl);
        const data = await response.json();
        
        // 2. AUTO-DETECT: Find the array containing data
        let halts = [];
        
        if (Array.isArray(data)) {
            halts = data;
        } else {
            // Recursive search for the first array in the object
            const findArray = (obj) => {
                for (let key in obj) {
                    if (Array.isArray(obj[key]) && obj[key].length > 0) return obj[key];
                    if (typeof obj[key] === 'object' && obj[key] !== null) {
                        const result = findArray(obj[key]);
                        if (result) return result;
                    }
                }
                return [];
            };
            halts = findArray(data);
        }

        // 3. DEBUG: Show exactly what we found
        console.log("Found Data:", halts);
        
        // Handle "No Active Halts" gracefully instead of throwing error
        if (!halts || halts.length === 0) {
            status.innerText = "CONNECTED: No active halts reported by API.";
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#ffff00">NO ACTIVE HALTS FOUND</td></tr>';
            return;
        }

        // 4. SMART MAPPING: Map dynamic keys to our table
        // (Finds keys regardless of capitalization: symbol/Symbol, haltTime/HaltTime)
        const getVal = (item, keywords) => {
            const key = Object.keys(item).find(k => keywords.some(kw => k.toLowerCase().includes(kw)));
            return key ? item[key] : null;
        };

        const luldHalts = halts.filter(item => {
            const reason = (getVal(item, ['reason', 'message']) || "").toLowerCase();
            return reason.includes("luld") || reason.includes("limit up");
        });

        status.innerText = `UPDATED: ${new Date().toLocaleTimeString()} | TOTAL: ${halts.length} | LULD: ${luldHalts.length}`;
        tbody.innerHTML = '';

        if (luldHalts.length === 0) {
             tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#666">NO ACTIVE LULD HALTS</td></tr>';
             return;
        }

        luldHalts.forEach(item => {
            const tr = document.createElement('tr');
            const sym = getVal(item, ['symbol', 'sym']) || "---";
            const time = getVal(item, ['halttime', 'time']) || "--:--";
            const resume = getVal(item, ['resumetime', 'resume']) || "PENDING";
            const reason = getVal(item, ['reason', 'message']) || "";

            tr.innerHTML = `<td>${sym}</td><td>${time}</td><td>${resume}</td><td>${reason}</td>`;
            tbody.appendChild(tr);
        });

    } catch (error) {
        console.error(error);
        status.innerHTML = `<span style="color:red">ERROR: ${error.message}</span>`;
        // Print the raw JSON to console so you can inspect it
        console.log("Inspect this object to see structure:", error);
    }
}

fetchHaltData();
setInterval(fetchHaltData, 60000);
</script>
